# 【原理】分页内存管理

在分页内存管理中，一方面把实际物理内存（也称主存）划分为许多个固定大小的内存块，称为物理页面，或者是页框（page frame）；另一方面又把CPU（包括程序员）看到的虚拟地址空间也划分为大小相同的块，称为虚拟页面，或者简称为页面、页（page）。页面的大小要求是2的整数次幂，一般在256个字节到4M字节之间。在本书中，页面的大小设定为4KB。在32位的86x86中，虚拟地址空间是4GB，物理地址空间也也是4GB，因此在理论上程序可访问到1M个虚拟页面和1M个物理页面。软件的每一物理页面都可以放置在主存中的任何地方，分页系统（需要CPU等硬件系统提供相应的分页机制硬件支持，详见下一节）提供了程序中使用的虚地址和主存中的物理地址之间的动态映射。这样当程序访问一个虚拟地址时，支持分页机制的相关硬件自动把CPU访问的虚拟地址虚拟地址拆分为页号（可能有多级页号）和页内偏移量，再把页号映射为页帧号，最后加上页内偏移组成一个物理地址，这样最终完成对这个地址的读/写/执行等操作。

假设程序在运行时要去读地址0x100的内容到寄存器1（用REG1表示）中，执行如下的指令：

    mov 0x100, REG1
  
虚拟地址0x100被发送给CPU内部的内存管理单元（MMU），然后MMU通过支持分页机制的相关硬件逻辑就会把这个虚拟地址是位于第0个虚拟页面当中（设页大小为4KB），页内偏移是0x100；而操作系统的分页管理子系统已经设置好第0个虚拟页面对应的是第2个物理页帧，物理页帧的起始地址是0x2000，然后再加上页内的偏移地址0x100，所以最后得到的物理地址就是0x2100。然后MMU就会把这个真正的物理地址发送到计算机系统中的地址总线上，从而可正确访问相应的物理内存单元。

如果操作系统的分页管理子系统没有设置第0个虚拟页面对应的物理页帧，则表示第0个虚拟页面当前没有对应的物理页帧，这会导致CPU产生一个缺页异常，由操作系统的缺页处理服务例程来选择如何处理。如果缺页处理服务例程认为这是一次非法访问，它将报错，终止软件运行；如果它认为是一次合理的访问，则它会采用分配物理页等手段建立正确的页映射，使得能够重新正确执行产生异常的访存指令。